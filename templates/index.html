<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Video Downloader</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            background-color: #121212; /* Even darker background */
            color: #e0e0e0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container {
            max-width: 900px; /* Wider container */
            margin: 2rem auto;
            padding: 2.5rem;
            background-color: #1e1e1e; /* Slightly lighter card background */
            border-radius: 12px; /* More rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3), 0 6px 10px rgba(0,0,0,0.22);
        }
        input, select, textarea {
            background-color: #2a2a2a; /* Darker input fields */
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 0.75rem 1rem;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #6366f1; /* Indigo focus */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5);
            outline: none;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary {
            background-color: #6366f1; /* Indigo button */
            color: white;
        }
        .btn-primary:hover {
            background-color: #4f46e5;
        }
        .btn-secondary {
            background-color: #38a169; /* Green button */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #2f855a;
        }
        #videoInfo img#thumbnail {
            width: 100%;
            max-width: 560px; /* Further Increased thumbnail width */
            border-radius: 8px;
            margin-bottom: 1.5rem; /* Added more margin */
            display: block; /* Ensure it behaves as a block for centering if needed */
            margin-left: auto;
            margin-right: auto;
        }
        img#channelLogo {
            width: 60px; /* Larger channel logo */
            height: 60px;
            border-radius: 50%; /* Circular logo */
            margin-right: 0.75rem;
            border: 2px solid #444;
        }
        
        /* WiFi Loading Animation from UIverse */
        #wifi-loader {
          --background: #62abff;
          --front-color: #4f29f0;
          --back-color: #c3c8de;
          --text-color: #414856;
          width: 64px;
          height: 64px;
          border-radius: 50px;
          position: relative;
          display: flex;
          justify-content: center;
          align-items: center;
          margin: 20px auto;
        }

        #wifi-loader svg {
          position: absolute;
          display: flex;
          justify-content: center;
          align-items: center;
        }

        #wifi-loader svg circle {
          position: absolute;
          fill: none;
          stroke-width: 6px;
          stroke-linecap: round;
          stroke-linejoin: round;
          transform: rotate(-100deg);
          transform-origin: center;
        }

        #wifi-loader svg circle.back {
          stroke: var(--back-color);
        }

        #wifi-loader svg circle.front {
          stroke: var(--front-color);
        }

        #wifi-loader svg.circle-outer {
          height: 86px;
          width: 86px;
        }

        #wifi-loader svg.circle-outer circle {
          stroke-dasharray: 62.75 188.25;
        }

        #wifi-loader svg.circle-outer circle.back {
          animation: circle-outer135 1.8s ease infinite 0.3s;
        }

        #wifi-loader svg.circle-outer circle.front {
          animation: circle-outer135 1.8s ease infinite 0.15s;
        }

        #wifi-loader svg.circle-middle {
          height: 60px;
          width: 60px;
        }

        #wifi-loader svg.circle-middle circle {
          stroke-dasharray: 42.5 127.5;
        }

        #wifi-loader svg.circle-middle circle.back {
          animation: circle-middle6123 1.8s ease infinite 0.25s;
        }

        #wifi-loader svg.circle-middle circle.front {
          animation: circle-middle6123 1.8s ease infinite 0.1s;
        }

        #wifi-loader svg.circle-inner {
          height: 34px;
          width: 34px;
        }

        #wifi-loader svg.circle-inner circle {
          stroke-dasharray: 22 66;
        }

        #wifi-loader svg.circle-inner circle.back {
          animation: circle-inner162 1.8s ease infinite 0.2s;
        }

        #wifi-loader svg.circle-inner circle.front {
          animation: circle-inner162 1.8s ease infinite 0.05s;
        }

        #wifi-loader .text {
          position: absolute;
          bottom: -40px;
          display: flex;
          justify-content: center;
          align-items: center;
          text-transform: lowercase;
          font-weight: 500;
          font-size: 14px;
          letter-spacing: 0.2px;
        }

        #wifi-loader .text::before, #wifi-loader .text::after {
          content: attr(data-text);
        }

        #wifi-loader .text::before {
          color: var(--text-color);
        }

        #wifi-loader .text::after {
          color: var(--front-color);
          animation: text-animation76 3.6s ease infinite;
          position: absolute;
          left: 0;
        }

        @keyframes circle-outer135 {
          0% {
            stroke-dashoffset: 25;
          }

          25% {
            stroke-dashoffset: 0;
          }

          65% {
            stroke-dashoffset: 301;
          }

          80% {
            stroke-dashoffset: 276;
          }

          100% {
            stroke-dashoffset: 276;
          }
        }

        @keyframes circle-middle6123 {
          0% {
            stroke-dashoffset: 17;
          }

          25% {
            stroke-dashoffset: 0;
          }

          65% {
            stroke-dashoffset: 204;
          }

          80% {
            stroke-dashoffset: 187;
          }

          100% {
            stroke-dashoffset: 187;
          }
        }

        @keyframes circle-inner162 {
          0% {
            stroke-dashoffset: 9;
          }

          25% {
            stroke-dashoffset: 0;
          }

          65% {
            stroke-dashoffset: 106;
          }

          80% {
            stroke-dashoffset: 97;
          }

          100% {
            stroke-dashoffset: 97;
          }
        }

        @keyframes text-animation76 {
          0% {
            clip-path: inset(0 100% 0 0);
          }

          50% {
            clip-path: inset(0);
          }

          100% {
            clip-path: inset(0 0 0 100%);
          }
        }
        
        /* Download WiFi Loading Animation - Green variant */
        #wifi-loader-download {
          --background: #4ade80;
          --front-color: #16a34a;
          --back-color: #c3c8de;
          --text-color: #414856;
          width: 64px;
          height: 64px;
          border-radius: 50px;
          position: relative;
          display: flex;
          justify-content: center;
          align-items: center;
          margin: 20px auto;
        }

        #wifi-loader-download svg {
          position: absolute;
          display: flex;
          justify-content: center;
          align-items: center;
        }

        #wifi-loader-download svg circle {
          position: absolute;
          fill: none;
          stroke-width: 6px;
          stroke-linecap: round;
          stroke-linejoin: round;
          transform: rotate(-100deg);
          transform-origin: center;
        }

        #wifi-loader-download svg circle.back {
          stroke: var(--back-color);
        }

        #wifi-loader-download svg circle.front {
          stroke: var(--front-color);
        }

        #wifi-loader-download svg.circle-outer {
          height: 86px;
          width: 86px;
        }

        #wifi-loader-download svg.circle-outer circle {
          stroke-dasharray: 62.75 188.25;
        }

        #wifi-loader-download svg.circle-outer circle.back {
          animation: circle-outer135 1.8s ease infinite 0.3s;
        }

        #wifi-loader-download svg.circle-outer circle.front {
          animation: circle-outer135 1.8s ease infinite 0.15s;
        }

        #wifi-loader-download svg.circle-middle {
          height: 60px;
          width: 60px;
        }

        #wifi-loader-download svg.circle-middle circle {
          stroke-dasharray: 42.5 127.5;
        }

        #wifi-loader-download svg.circle-middle circle.back {
          animation: circle-middle6123 1.8s ease infinite 0.25s;
        }

        #wifi-loader-download svg.circle-middle circle.front {
          animation: circle-middle6123 1.8s ease infinite 0.1s;
        }

        #wifi-loader-download svg.circle-inner {
          height: 34px;
          width: 34px;
        }

        #wifi-loader-download svg.circle-inner circle {
          stroke-dasharray: 22 66;
        }

        #wifi-loader-download svg.circle-inner circle.back {
          animation: circle-inner162 1.8s ease infinite 0.2s;
        }

        #wifi-loader-download svg.circle-inner circle.front {
          animation: circle-inner162 1.8s ease infinite 0.05s;
        }

        #wifi-loader-download .text {
          position: absolute;
          bottom: -40px;
          display: flex;
          justify-content: center;
          align-items: center;
          text-transform: lowercase;
          font-weight: 500;
          font-size: 14px;
          letter-spacing: 0.2px;
        }

        #wifi-loader-download .text::before, #wifi-loader-download .text::after {
          content: attr(data-text);
        }

        #wifi-loader-download .text::before {
          color: var(--text-color);
        }

        #wifi-loader-download .text::after {
          color: var(--front-color);
          animation: text-animation76 3.6s ease infinite;
          position: absolute;
          left: 0;
        }
        
        /* Original spinner - keeping for reference but not using */
        .spinner {
            border: 4px solid rgba(224, 224, 224, 0.2);
            border-radius: 50%;
            border-top: 4px solid #6366f1; /* Indigo spinner */
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none; /* Hide the original spinner */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            color: #f87171; /* Red error message */
            background-color: rgba(239, 68, 68, 0.1);
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #ef4444;
            display: flex;
            align-items: center;
        }
        .info-label {
            font-weight: 500;
            color: #a0aec0; /* Lighter gray for labels */
        }
        .info-value {
            color: #e2e8f0;
        }
        .form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #a0aec0;
            margin-bottom: 0.5rem;
            display: block;
        }
        .icon {
            width: 1.25em;
            height: 1.25em;
            margin-right: 0.5em;
            vertical-align: middle;
        }
        /* Success Checkmark Animation */
        .checkmark__circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 2;
            stroke-miterlimit: 10;
            stroke: #4ade80; /* Green-400 */
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }
        .checkmark {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: none; /* Hidden by default */
            stroke-width: 2;
            stroke: #fff;
            stroke-miterlimit: 10;
            margin: 0 auto 10px auto; /* Centered with margin */
            box-shadow: inset 0px 0px 0px #4ade80;
            animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        }
        .checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }
        @keyframes stroke {
            100% {
                stroke-dashoffset: 0;
            }
        }
        @keyframes scale {
            0%, 100% {
                transform: none;
            }
            50% {
                transform: scale3d(1.1, 1.1, 1);
            }
        }
        @keyframes fill {
            100% {
                box-shadow: inset 0px 0px 0px 30px #4ade80;
            }
        }
        .btn-warning {
            background-color: #F59E0B; /* amber-500 */
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-warning:hover {
            background-color: #D97706; /* amber-600 */
        }
        .btn-warning:disabled {
            background-color: #bca065;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="text-gray-200">
    <div class="container">
        <header class="text-center mb-10">
            <svg class="w-16 h-16 text-indigo-400 mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
            <h1 class="text-4xl font-bold text-indigo-300">YouTube Video Downloader</h1>
            <p class="text-gray-400 mt-2">Fetch info, choose quality, and download your favorite YouTube videos.</p>
        </header>

        <div class="space-y-6">
            <div>
                <label for="youtubeUrl" class="form-label">YouTube Video URL:</label>
                <input type="text" id="youtubeUrl" class="w-full" placeholder="e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ">
            </div>

            <div>
                <label for="cookiesContent" class="form-label">Cookies (Netscape format, optional but recommended):</label>
                <textarea id="cookiesContent" name="cookies_content" rows="5" class="w-full p-2.5 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500 text-sm shadow-sm resize-y" placeholder="Paste your YouTube cookies here in Netscape format..."></textarea>
                <p class="mt-1 text-xs text-gray-400">Required for age-restricted or private videos. Export from browser using an extension like 'EditThisCookie' or 'Cookie-Editor'.</p>
            </div>

            <button id="fetchInfoBtn" class="btn btn-primary w-full">
                <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                </svg>
                Fetch Video Info
            </button>
        </div>

        <div id="loadingSpinner" class="hidden">
            <div id="wifi-loader">
                <svg class="circle-outer" viewBox="0 0 86 86">
                    <circle class="back" cx="43" cy="43" r="40"></circle>
                    <circle class="front" cx="43" cy="43" r="40"></circle>
                    <circle class="new" cx="43" cy="43" r="40"></circle>
                </svg>
                <svg class="circle-middle" viewBox="0 0 60 60">
                    <circle class="back" cx="30" cy="30" r="27"></circle>
                    <circle class="front" cx="30" cy="30" r="27"></circle>
                </svg>
                <svg class="circle-inner" viewBox="0 0 34 34">
                    <circle class="back" cx="17" cy="17" r="14"></circle>
                    <circle class="front" cx="17" cy="17" r="14"></circle>
                </svg>
                <div class="text" data-text="fetching"></div>
            </div>
        </div>
        <div id="errorMessage" class="hidden">
            <div class="bg-red-50 border border-red-100 rounded-md p-4 mb-5 flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800" id="errorText">Error message here</h3>
                    <div id="errorDetails" class="mt-2 text-sm text-red-700 hidden">
                        <!-- Additional error details will appear here -->
                    </div>
                    <div id="unavailableHelp" class="mt-2 text-sm text-gray-600 hidden">
                        <p>This typically happens when:</p>
                        <ul class="list-disc pl-5 mt-1">
                            <li>The video has been deleted or made private by the owner</li>
                            <li>The video is geo-restricted and not available in our server's region</li>
                            <li>The video requires age verification or account login</li>
                        </ul>
                        <p class="mt-2">Try providing complete authentication cookies from an active YouTube session to access restricted content.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="videoInfo" class="mt-10 hidden bg-gray-800 p-6 rounded-lg shadow-md">
            <h2 class="text-3xl font-semibold mb-6 text-indigo-200 border-b border-gray-700 pb-3">Video Details</h2>
            <div class="grid md:grid-cols-3 gap-8">
                <div class="md:col-span-1 flex flex-col items-center">
                    <img id="thumbnail" src="" alt="Video Thumbnail" class="shadow-lg">
                </div>
                <div class="md:col-span-2 space-y-3">
                    <h3 id="title" class="text-2xl font-bold text-gray-100"></h3>
                    <div class="flex items-center py-2">
                        <img id="channelLogo" src="" alt="Channel Logo" class="shadow-sm">
                        <span id="channelName" class="info-value text-xl font-medium ml-3"></span>
                    </div>
                    <p class="flex items-center"><svg class="icon text-gray-400 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" /></svg><span class="info-label">Subscribers:</span> <span id="subscribers" class="info-value ml-1"></span></p>
                    <p class="flex items-center"><svg class="icon text-gray-400 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg><span class="info-label">Views:</span> <span id="views" class="info-value ml-1"></span></p>
                    <p class="flex items-center"><svg class="icon text-gray-400 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.865.205A2 2 0 006 10.333z" /></svg><span class="info-label">Likes:</span> <span id="likes" class="info-value ml-1"></span></p>
                    <p class="flex items-center"><svg class="icon text-gray-400 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" /></svg><span class="info-label">Comments:</span> <span id="comments" class="info-value ml-1"></span></p>
                    <p class="flex items-center"><svg class="icon text-gray-400 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg><span class="info-label">Duration:</span> <span id="duration" class="info-value ml-1"></span></p>
                    <p class="mt-3"><span class="info-label">Best Available Quality:</span> <span id="maxQuality" class="info-value font-bold text-green-400 text-lg ml-1"></span></p>
                </div>
            </div>
            
            <div class="mt-8 pt-6 border-t border-gray-700">
                 <h4 class="form-label text-lg mb-2">- Available downloads</h4>
                <div class="flex flex-col sm:flex-row items-center gap-4">
                    <select id="qualitySelect" class="w-full sm:w-auto flex-grow p-3">
                        <optgroup label="Video Downloads">
                        </optgroup>
                        <optgroup label="Audio Downloads" style="color: #4ade80;">
                        <option value="mp3" style="color: #4ade80;">MP3 Audio</option>
                        </optgroup>
                        <optgroup label="Media Assets" style="color: #60a5fa;">
                            <option value="thumbnail" style="color: #60a5fa;">Download Thumbnail</option>
                            <option value="logo" style="color: #60a5fa;">Download Channel Logo</option>
                        </optgroup>
                    </select>
                    <button id="downloadBtn" class="btn btn-secondary w-full sm:w-auto">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.905 3.079V2.75z" />
                            <path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" />
                        </svg>
                        Download Selected Format
                    </button>
                </div>
                <div id="downloadingSpinner" class="hidden mt-4">
                    <div id="wifi-loader-download">
                        <svg class="circle-outer" viewBox="0 0 86 86">
                            <circle class="back" cx="43" cy="43" r="40"></circle>
                            <circle class="front" cx="43" cy="43" r="40"></circle>
                            <circle class="new" cx="43" cy="43" r="40"></circle>
                        </svg>
                        <svg class="circle-middle" viewBox="0 0 60 60">
                            <circle class="back" cx="30" cy="30" r="27"></circle>
                            <circle class="front" cx="30" cy="30" r="27"></circle>
                        </svg>
                        <svg class="circle-inner" viewBox="0 0 34 34">
                            <circle class="back" cx="17" cy="17" r="14"></circle>
                            <circle class="front" cx="17" cy="17" r="14"></circle>
                        </svg>
                        <div class="text" data-text="downloading"></div>
                    </div>
                </div>
                <div id="downloadStatus" class="mt-4 text-sm text-center">
                    <!-- SVG Checkmark will be injected here by JS -->
                </div>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-700">
                <h4 class="text-xl font-semibold mb-2 text-indigo-200">Description:</h4>
                <pre id="description" class="whitespace-pre-wrap text-sm bg-gray-700 p-4 rounded-md max-h-60 overflow-y-auto leading-relaxed"></pre>
            </div>
        </div>
    </div>

    <script>
        const fetchInfoBtn = document.getElementById('fetchInfoBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const youtubeUrlInput = document.getElementById('youtubeUrl');
        const cookiesContentInput = document.getElementById('cookiesContent');
        const videoInfoDiv = document.getElementById('videoInfo');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const downloadingSpinner = document.getElementById('downloadingSpinner');
        const errorMessageDiv = document.getElementById('errorMessage');
        const errorTextSpan = document.getElementById('errorText');
        const qualitySelect = document.getElementById('qualitySelect');
        const downloadStatus = document.getElementById('downloadStatus');
        let currentUrl = '';
        let currentChannelId = '';
        let originalDownloadIconHTML = '';

        const MAX_RETRIES = 3;
        const RETRY_DELAY_MS = 3000; // 3 seconds

        const allVideoQualities = [
            { value: "8K", text: "8K (4320p)", numeric: 4320 },
            { value: "4K", text: "4K (2160p)", numeric: 2160 },
            { value: "2K", text: "2K (1440p)", numeric: 1440 },
            { value: "1080p", text: "1080p (Full HD)", numeric: 1080 },
            { value: "720p", text: "720p (HD)", numeric: 720 },
            { value: "480p", text: "480p", numeric: 480 },
            { value: "360p", text: "360p", numeric: 360 }
        ];

        // Helper function for retrying fetch operations
        async function fetchWithRetries(url, options, onSuccess, maxRetries = 2) {
            let retries = 0;
            while (retries <= maxRetries) {
                try {
                    const response = await fetch(url, options);
                    const data = await response.json();
                    
                    if (!response.ok) {
                        // Check if we should show the unavailable video guidance
                        const isUnavailable = data.is_unavailable || response.status === 404;
                        const statusCode = response.status;
                        
                        if (retries < maxRetries) {
                            console.log(`Request failed with status ${response.status}, retrying (${retries + 1}/${maxRetries})...`);
                            retries++;
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            continue;
                        }
                        
                        console.error(`Request failed after ${maxRetries} retries with status ${response.status}:`, data);
                        displayError(data.error || `Failed with status code ${response.status}`, statusCode, isUnavailable);
                        return null;
                    }
                    
                    onSuccess(data);
                    return data;
                } catch (error) {
                    if (retries < maxRetries) {
                        console.log(`Request threw error, retrying (${retries + 1}/${maxRetries})...`, error);
                        retries++;
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        continue;
                    }
                    
                    console.error(`Request failed after ${maxRetries} retries:`, error);
                    displayError(`Network error: ${error.message || 'Could not connect to server'}`);
                    return null;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const btnIcon = downloadBtn.querySelector('svg');
            if (btnIcon) {
                originalDownloadIconHTML = btnIcon.outerHTML;
            } else {
                // Fallback if SVG not found immediately (e.g. complex rendering)
                originalDownloadIconHTML = '<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.905 3.079V2.75z" /><path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" /></svg>';
            }
            updateDownloadButtonText(); // Initial call to set button text correctly
        });

        // Ensure error message and download status are hidden/cleared on initial script execution after DOM is ready
        if (errorMessageDiv) {
            errorMessageDiv.style.display = 'none';
            if (errorTextSpan) {
                errorTextSpan.textContent = ''; // Explicitly clear on load
            }
        }
        if (downloadStatus) {
            downloadStatus.textContent = '';
            downloadStatus.className = 'mt-4 text-sm text-gray-400 text-center'; // Ensure centering and default color
        }

        // Add event listener to qualitySelect to update downloadBtn text
        qualitySelect.addEventListener('change', function() {
            updateDownloadButtonText();
        });
        
        // Function to update download button text based on selected quality
        function updateDownloadButtonText() {
            const selectedQuality = qualitySelect.value;

            // Ensure originalDownloadIconHTML is available
            if (!originalDownloadIconHTML && downloadBtn && downloadBtn.querySelector('svg')) {
                originalDownloadIconHTML = downloadBtn.querySelector('svg').outerHTML;
            }

            if (selectedQuality === 'mp3') {
                downloadBtn.innerHTML = `${originalDownloadIconHTML || ''} Download MP3 Audio`;
            } else if (selectedQuality === 'thumbnail') {
                downloadBtn.innerHTML = `${originalDownloadIconHTML || ''} Download Thumbnail`;
            } else if (selectedQuality === 'logo') {
                downloadBtn.innerHTML = `${originalDownloadIconHTML || ''} Download Channel Logo`;
            } else {
                downloadBtn.innerHTML = `${originalDownloadIconHTML || ''} Download ${selectedQuality} Video`;
            }
        }

        fetchInfoBtn.addEventListener('click', async () => {
            currentUrl = youtubeUrlInput.value.trim();
            const cookies = cookiesContentInput.value.trim();

            if (!currentUrl) {
                displayError('Please enter a YouTube URL.');
                return;
            }

            // Clear previous info and errors
            videoInfoDiv.classList.add('hidden');
            errorMessageDiv.style.display = 'none';
            if (downloadStatus) downloadStatus.innerHTML = '';

            // Show WiFi loader animation only and hide the button completely
            loadingSpinner.classList.remove('hidden');
            fetchInfoBtn.disabled = true;
            fetchInfoBtn.style.display = 'none'; // Hide the button completely while loading
            
            try {
                const data = await fetchWithRetries(
                    '/fetch_info',
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ url: currentUrl, cookies_content: cookies }),
                    },
                    (data) => {
                        currentChannelId = data.channel_id || '';
                        const thumbnailEl = document.getElementById('thumbnail');
                        if (thumbnailEl) thumbnailEl.src = `/download_thumbnail/${data.id}`;
                        const titleEl = document.getElementById('title');
                        if (titleEl) titleEl.textContent = data.title || 'N/A';
                        const channelLogoEl = document.getElementById('channelLogo');
                        if (channelLogoEl) channelLogoEl.src = data.channel_logo || '';
                        const channelNameEl = document.getElementById('channelName');
                        if (channelNameEl) channelNameEl.textContent = data.channel_name || 'N/A';
                        const subscribersEl = document.getElementById('subscribers');
                        if (subscribersEl) subscribersEl.textContent = data.subscribers || 'N/A';
                        const viewsEl = document.getElementById('views');
                        if (viewsEl) viewsEl.textContent = data.views || 'N/A';
                        const likesEl = document.getElementById('likes');
                        if (likesEl) likesEl.textContent = data.likes || 'N/A';
                        const commentsEl = document.getElementById('comments');
                        if (commentsEl) commentsEl.textContent = data.comments || 'N/A';
                        const descriptionEl = document.getElementById('description');
                        if (descriptionEl) descriptionEl.textContent = data.description || 'N/A';
                        const maxQualityEl = document.getElementById('maxQuality');
                        if (maxQualityEl) maxQualityEl.textContent = data.max_quality || 'N/A';
                        const durationEl = document.getElementById('duration');
                        if (durationEl) durationEl.textContent = data.duration || 'N/A';
                        const videoOptgroup = qualitySelect.querySelector('optgroup[label="Video Downloads"]');
                        if (videoOptgroup) {
                            videoOptgroup.innerHTML = '';
                            let defaultSelectedQualityValue = null;
                            
                            // Use available_qualities from API response if available
                            if (data.available_qualities && Array.isArray(data.available_qualities) && data.available_qualities.length > 0) {
                                // Map the available qualities to options
                                data.available_qualities.forEach(qualityValue => {
                                    // Find the corresponding quality in allVideoQualities
                                    const qualityInfo = allVideoQualities.find(q => q.value === qualityValue);
                                    if (qualityInfo) {
                                        const option = document.createElement('option');
                                        option.value = qualityInfo.value;
                                        option.textContent = qualityInfo.text;
                                        videoOptgroup.appendChild(option);
                                        if (!defaultSelectedQualityValue) {
                                            defaultSelectedQualityValue = qualityInfo.value;
                                        }
                                    }
                                });
                            } else {
                                // Fallback to old behavior if available_qualities is not provided
                                let bestQualityNumeric = 0;
                                
                                // Add a check to make sure data.max_quality exists before trying to use includes()
                                if (data.max_quality) {
                                    if (data.max_quality.includes("8K")) bestQualityNumeric = 4320;
                                    else if (data.max_quality.includes("4K")) bestQualityNumeric = 2160;
                                    else if (data.max_quality.includes("2K")) bestQualityNumeric = 1440;
                                    else if (data.max_quality.includes("1080p")) bestQualityNumeric = 1080;
                                    else if (data.max_quality.includes("720p")) bestQualityNumeric = 720;
                                    else if (data.max_quality.includes("480p")) bestQualityNumeric = 480;
                                    else if (data.max_quality.includes("360p")) bestQualityNumeric = 360;
                                    else {
                                        const pValueMatch = data.max_quality.match(/(\d+)p/);
                                        if (pValueMatch && pValueMatch[1]){
                                            bestQualityNumeric = parseInt(pValueMatch[1], 10);
                                        }
                                    }
                                } else {
                                    // Default to 720p if max_quality is not provided
                                    bestQualityNumeric = 720;
                                }
                                
                                // Cap at 2K since we're not supporting 4K+ downloads
                                if (bestQualityNumeric > 1440) bestQualityNumeric = 1440;
                                
                                allVideoQualities.forEach(quality => {
                                    if (quality.numeric <= bestQualityNumeric) {
                                        const option = document.createElement('option');
                                        option.value = quality.value;
                                        option.textContent = quality.text;
                                        videoOptgroup.appendChild(option);
                                        if (!defaultSelectedQualityValue) {
                                            defaultSelectedQualityValue = quality.value;
                                        }
                                    }
                                });
                            }
                            
                            if (defaultSelectedQualityValue) {
                                qualitySelect.value = defaultSelectedQualityValue;
                            } else {
                                const option = document.createElement('option');
                                option.value = "360p";
                                option.textContent = "360p (Not available)";
                                option.disabled = true;
                                videoOptgroup.appendChild(option);
                                qualitySelect.value = "360p";
                            }
                        } else {
                            console.error("Video Downloads optgroup not found!");
                        }
                        updateDownloadButtonText();
                        videoInfoDiv.classList.remove('hidden');
                        errorMessageDiv.style.display = 'none'; // Hide error message on success
                    },
                    MAX_RETRIES
                );
            } finally {
                // Reset button state in finally block
                loadingSpinner.classList.add('hidden');
                fetchInfoBtn.disabled = false;
                fetchInfoBtn.style.display = ''; // Show the button again
                fetchInfoBtn.innerHTML = `
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                    Fetch Video Info`;
            }
        });

        downloadBtn.addEventListener('click', async () => {
            const selectedQuality = qualitySelect.value;
            const cookies = cookiesContentInput.value.trim();

            if (!currentUrl) {
                displayError('No URL specified. Please fetch info first.');
                return;
            }

            if (selectedQuality === 'thumbnail') {
                const videoId = extractVideoId(currentUrl);
                if (!videoId) {
                    displayError('Could not extract video ID from URL.');
                    return;
                }
                window.location.href = `/download_thumbnail/${videoId}`;
                return;
            }
            
            if (selectedQuality === 'logo') {
                const channelId = currentChannelId; 
                if (!channelId) {
                    displayError('Channel ID not available. Please fetch video info again.');
                    return;
                }
                window.location.href = `/download_channel_logo/${channelId}`;
                return;
            }

            // Clear previous status/errors specific to download button area
            if(downloadStatus) {
                downloadStatus.innerHTML = ''; 
                downloadStatus.className = 'mt-4 text-sm text-gray-400 text-center';
            }
            errorMessageDiv.style.display = 'none'; // Hide general error message too

            // Show only the downloadingSpinner during download and hide the button completely
            downloadingSpinner.classList.remove('hidden');
            downloadBtn.disabled = true;
            downloadBtn.style.display = 'none'; // Hide the button completely while loading
            
            try {
                const data = await fetchWithRetries(
                    '/download',
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ url: currentUrl, quality: selectedQuality, cookies_content: cookies }),
                    },
                    (data) => {
                        if (downloadStatus) {
                            let successMessageHtml;
                            const selectedQualityValue = qualitySelect.value;
                            if (selectedQualityValue === 'mp3') {
                                successMessageHtml = `
                                    <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                                        <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                                        <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                                    </svg>
                                    <p class="text-green-400">Audio downloaded successfully! Open ${data.filename} (or similar if auto-renamed) in your device to listen to your audio.</p>
                                `;
                            } else {
                                successMessageHtml = `
                                    <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                                        <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                                        <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                                    </svg>
                                    <p class="text-green-400">Download Succeeded! Preparing ${data.filename}...</p>
                                    <p class="text-xs text-gray-500 mt-1">Your browser will prompt you to save the file.</p>
                                `;
                            }
                            downloadStatus.innerHTML = successMessageHtml;
                            const checkmarkSvg = downloadStatus.querySelector('.checkmark');
                            if(checkmarkSvg) checkmarkSvg.style.display = 'block';
                            
                            setTimeout(() => {
                                if(downloadStatus) {
                                    downloadStatus.innerHTML = '';
                                    downloadStatus.className = 'mt-4 text-sm text-gray-400 text-center';
                                }
                            }, 7000);
                        }
                        
                        // Check if download_url exists and is a valid URL
                        if (data.download_url) {
                            // Ensure we have a valid path, add /downloads/ prefix if needed
                            let downloadUrl = data.download_url;
                            if (!downloadUrl.startsWith('/downloads/') && !downloadUrl.startsWith('http')) {
                                downloadUrl = '/downloads/' + downloadUrl;
                            }
                            
                            // Trigger the actual file download via browser
                            const link = document.createElement('a');
                            link.href = downloadUrl;
                            link.setAttribute('download', data.filename || 'video.mp4');
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        } else {
                            console.error("Download URL not provided in server response");
                        }
                        
                        errorMessageDiv.style.display = 'none'; // Hide general error on download success
                    },
                    MAX_RETRIES
                );
            } finally {
                // Hide loading spinner after download (success or failure)
                downloadingSpinner.classList.add('hidden');
                // Reset button state in finally block
                downloadBtn.disabled = false;
                downloadBtn.style.display = ''; // Show the button again
                updateDownloadButtonText(); 
            }
        });

        function displayError(message, statusCode, isUnavailable) {
            console.log("displayError called with:", { message, statusCode, isUnavailable });
            
            // Clear any download status when showing an error
            if (downloadStatus) {
                downloadStatus.innerHTML = '';
                downloadStatus.className = 'mt-4 text-sm text-gray-400 text-center';
            }

            const finalMessage = message || "An unexpected error occurred.";
            
            if (errorTextSpan) {
                errorTextSpan.textContent = finalMessage;
            }
            
            // Handle specific error types
            const errorDetailsEl = document.getElementById('errorDetails');
            const unavailableHelpEl = document.getElementById('unavailableHelp');
            
            if (errorDetailsEl) {
                errorDetailsEl.classList.add('hidden');
                errorDetailsEl.innerHTML = '';
            }
            
            if (unavailableHelpEl) {
                if (isUnavailable || statusCode === 404) {
                    unavailableHelpEl.classList.remove('hidden');
                } else {
                    unavailableHelpEl.classList.add('hidden');
                }
            }

            // Show the error message div
            if (errorMessageDiv) {
                errorMessageDiv.style.display = 'flex';
            }
            
            // Hide the video info div
            if (videoInfoDiv) {
                videoInfoDiv.classList.add('hidden');
            }
        }

        // Add a helper function to extract video ID from URL
        function extractVideoId(url) {
            const regex = /(?:v=|\/)([\w-]{11})(?:\?|&|\/|$)/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }
    </script>
</body>
</html> 